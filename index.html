<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spotify PKCE + Embed Player</title>
<style>
body { font-family:'Poppins', sans-serif; background:#121212; color:white; text-align:center; margin:0; padding:0; }
h1 { margin-top:20px; color:#1DB954; }
input { width:60%; padding:10px; border-radius:25px; border:none; margin-top:20px; font-size:1em; }
button { background:#1DB954; color:white; border:none; padding:10px 20px; border-radius:25px; cursor:pointer; margin-left:10px; font-size:1em; }
.results { display:flex; flex-wrap:wrap; justify-content:center; margin-top:30px; gap:20px;}
.track { background:#181818; border-radius:10px; width:300px; padding:10px; transition:transform 0.2s;}
.track:hover { transform:scale(1.03); }
.track img { width:100%; border-radius:10px; margin-bottom:10px;}
iframe, audio { width:100%; margin-top:10px; border-radius:10px;}
</style>
</head>
<body>

<h1>Spotify PKCE + Embed Player ðŸŽµ</h1>
<div>
<input type="text" id="query" placeholder="Search for a song or artist...">
<button onclick="search()">Search</button>
</div>
<div class="results" id="results"></div>

<script>
// -------------------- PKCE HELPERS --------------------
function generateCodeVerifier(length = 128) {
const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
let text = "";
for (let i=0;i<length;i++) text += chars.charAt(Math.floor(Math.random()*chars.length));
return text;
}

function base64UrlEncode(arrayBuffer) {
let str = btoa(String.fromCharCode.apply(null, new Uint8Array(arrayBuffer)));
return str.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

async function generateCodeChallenge(verifier) {
const encoder = new TextEncoder();
const data = encoder.encode(verifier);
const digest = await crypto.subtle.digest("SHA-256", data);
return base64UrlEncode(digest);
}

// -------------------- SPOTIFY CONFIG --------------------
const clientId = "099d1840837545d48030a17fabb35754"; // your Spotify Client ID
const redirectUri = "https://yert21.github.io/spot-pl2/"; // must match Spotify Dashboard
let accessToken = null;

// -------------------- LOGIN FLOW --------------------
async function loginPKCE() {
const verifier = generateCodeVerifier();
localStorage.setItem("pkce_verifier", verifier);
const challenge = await generateCodeChallenge(verifier);

const authUrl = `https://accounts.spotify.com/authorize` +
`?client_id=${clientId}` +
`&response_type=code` +
`&redirect_uri=${encodeURIComponent(redirectUri)}` +
`&scope=streaming user-read-private user-read-email user-modify-playback-state user-read-playback-state` +
`&code_challenge=${challenge}` +
`&code_challenge_method=S256`;

window.location.href = authUrl;
}

async function handleRedirect() {
const params = new URLSearchParams(window.location.search);
const code = params.get("code");

if (code) {
const verifier = localStorage.getItem("pkce_verifier");
const body = new URLSearchParams();
body.append("client_id", clientId);
body.append("grant_type", "authorization_code");
body.append("code", code);
body.append("redirect_uri", redirectUri);
body.append("code_verifier", verifier);

const res = await fetch("https://accounts.spotify.com/api/token", {
method: "POST",
headers: { "Content-Type": "application/x-www-form-urlencoded" },
body
});

const data = await res.json();
if (data.access_token) {
accessToken = data.access_token;
localStorage.setItem("spotify_token", accessToken);
window.history.replaceState({}, document.title, redirectUri);
} else {
alert("Login failed. Try again.");
localStorage.removeItem("spotify_token");
loginPKCE();
}
} else {
accessToken = localStorage.getItem("spotify_token");
if (!accessToken) await loginPKCE();
}
}

// -------------------- SEARCH & RESULTS --------------------
async function search() {
const query = document.getElementById("query").value;
if (!query || !accessToken) return;

const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`, {
headers: { Authorization: `Bearer ${accessToken}` }
});

if (!res.ok) {
alert("Token expired or invalid, logging in again...");
localStorage.removeItem("spotify_token");
loginPKCE();
return;
}

const data = await res.json();
showResults(data.tracks.items);
}

function showResults(tracks) {
const container = document.getElementById("results");
container.innerHTML = "";

tracks.forEach(track => {
const div = document.createElement("div");
div.className = "track";
div.innerHTML = `
<img src="${track.album.images[0]?.url}" alt="Album Art">
<h3>${track.name}</h3>
<p>${track.artists.map(a=>a.name).join(", ")}</p>
${track.preview_url
? `<audio controls src="${track.preview_url}"></audio>`
: `<iframe src="https://open.spotify.com/embed/track/${track.id}" width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`}
`;
container.appendChild(div);
});
}

// -------------------- INIT --------------------
handleRedirect();
</script>

</body>
</html>
