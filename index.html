<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spotify Search Player PKCE</title>
<style>
body { font-family: 'Poppins', sans-serif; background:#121212; color:white; text-align:center; margin:0; padding:0;}
h1 { margin-top:20px; color:#1DB954; }
input { width:60%; padding:10px; border-radius:25px; border:none; margin-top:20px; font-size:1em;}
button { background:#1DB954; color:white; border:none; padding:10px 20px; border-radius:25px; cursor:pointer; margin-left:10px; font-size:1em;}
.results { display:flex; flex-wrap:wrap; justify-content:center; margin-top:30px; gap:20px;}
.track { background:#181818; border-radius:10px; width:200px; padding:10px; transition:transform 0.2s;}
.track:hover { transform:scale(1.05); }
img { width:100%; border-radius:10px;}
audio { width:100%; margin-top:10px;}
</style>
</head>
<body>
<h1>Spotify Search Player ðŸŽµ</h1>
<div>
<input type="text" id="query" placeholder="Search for a song or artist...">
<button onclick="search()">Search</button>
</div>
<div class="results" id="results"></div>

<script>
// ---------- CONFIG ----------
const clientId = "099d1840837545d48030a17fabb35754"; // Your Spotify App Client ID
const redirectUri = "https://yert21.github.io/spot-pl2/"; // Your GitHub Pages URL

let accessToken = null;
let codeVerifier = null;

// ---------- UTILITY ----------
function generateRandomString(length) {
const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
let result = '';
for (let i=0;i<length;i++) result += chars.charAt(Math.floor(Math.random()*chars.length));
return result;
}

async function sha256(plain) {
const encoder = new TextEncoder();
const data = encoder.encode(plain);
const hash = await crypto.subtle.digest('SHA-256', data);
return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

// ---------- PKCE FLOW ----------
async function login() {
codeVerifier = generateRandomString(128);
localStorage.setItem('code_verifier', codeVerifier);
const codeChallenge = await sha256(codeVerifier);

const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&code_challenge_method=S256&code_challenge=${codeChallenge}&scope=user-read-private`;
window.location.href = authUrl;
}

// ---------- TOKEN EXCHANGE ----------
async function getAccessToken(code) {
const verifier = localStorage.getItem('code_verifier');

const body = new URLSearchParams({
grant_type: 'authorization_code',
code: code,
redirect_uri: redirectUri,
client_id: clientId,
code_verifier: verifier
});

const res = await fetch('https://accounts.spotify.com/api/token', {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: body
});

const data = await res.json();
accessToken = data.access_token;
localStorage.setItem('access_token', accessToken);
}

// ---------- INIT ----------
async function init() {
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get('code');
if (code) {
await getAccessToken(code);
window.history.replaceState({}, document.title, "/"); // remove ?code= from URL
} else {
accessToken = localStorage.getItem('access_token');
if (!accessToken) login();
}
}

// ---------- SEARCH ----------
async function search() {
const q = document.getElementById('query').value;
if (!q || !accessToken) return;

const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track&limit=10`, {
headers: { Authorization: `Bearer ${accessToken}` }
});
const data = await res.json();
showResults(data.tracks.items);
}

function showResults(tracks) {
const container = document.getElementById('results');
container.innerHTML = '';
tracks.forEach(track => {
const div = document.createElement('div');
div.className = 'track';
div.innerHTML = `
<img src="${track.album.images[0]?.url}" alt="album art">
<h3>${track.name}</h3>
<p>${track.artists.map(a => a.name).join(', ')}</p>
${track.preview_url ? `<audio controls src="${track.preview_url}"></audio>` : "<p>No preview</p>"}
`;
container.appendChild(div);
});
}

// ---------- RUN ----------
init();
</script>
</body>
</html>
